<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>multivocal-example-auth2</title>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

    <script src="/__/firebase/5.1.0/firebase-app.js"></script>
    <script src="/__/firebase/5.1.0/firebase-database.js"></script>
    <script src="/__/firebase/init.js"></script>

    <!--
    <meta name="google-signin-client_id" content="">
    <meta name="google-signin-scope" content="profile email openid https://www.googleapis.com/auth/drive.metadata.readonly">

      var config = {
        "client_id": "811948997887-hvbc7o5ot2m559b822unj3lm46toq365.apps.googleusercontent.com",
        "scope": "profile email openid https://www.googleapis.com/auth/drive.metadata.readonly"
      };
    -->

    <script>

      var database = firebase.database();
      var conf;
      database.ref('/web').once('value').then(function(snapshot){
        var config = snapshot.val();
        console.log('config',config);
        conf = config;
        return config;

      }).then(function(){
        var config = conf.signin;
        var keys = Object.keys( config );
        for( var co=0; co<keys.length; co++ ){
          var name = keys[co];
          var content = config[name];
          var tag = '<meta name="google-signin-'+name+'" content="'+content+'">';
          console.log( tag );
          $('head').append(tag);
        }
        tag = '<script src="https://apis.google.com/js/client:platform.js?onload=start" async defer>';
        $('head').append(tag);

      });


      function start(){
        console.log('start');
        // Remove the existing callback and add our own to initiate a login
        // with offline access
        $('#g-signin2').children().prop('onclick',null).on('click');
        $('#g-signin2').click(function(){
          console.log( 'click' );

          var auth2 = gapi.auth2.getAuthInstance();
          auth2.then(function(){
            console.log( 'initialized' );
            return auth2.grantOfflineAccess();
          }).then(onSignIn);
        });
      }

      function onSignIn( googleUser ) {
        console.log( 'signed in', googleUser );

        var url = conf.codeExchange.uri;
        $.ajax({
          type: 'POST',
          url: url,
          contentType: 'application/json',
          processData: false,
          data: JSON.stringify(googleUser),
          success: onSuccess
        });
      }

      function onSuccess( data, status, xhr ){
        console.log( status );
        console.log( data );
      }
    </script>

  </head>
  <body>
  <h1>Multivocal Example Auth2</h1>

  <!-- https://developers.google.com/identity/sign-in/web/server-side-flow#step_4_add_the_sign-in_button_to_your_page -->
  <div id="g-signin2" class="g-signin2"></div>

  </body>
</html>
